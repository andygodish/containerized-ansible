name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    steps:
      - uses: google-github-actions/release-please-action@v4
        id: release
        with:
          release-type: simple
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
      
      # Only run the following if a release was created
      - uses: actions/checkout@v3
        if: ${{ steps.release.outputs.release_created }}
        
      - name: Extract version from release
        if: ${{ steps.release.outputs.release_created }}
        id: version
        run: |
          VERSION=${{ steps.release.outputs.tag_name }}
          # Remove 'v' prefix if present
          VERSION=${VERSION#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Released version: $VERSION"
      
      - name: Set up Docker Buildx
        if: ${{ steps.release.outputs.release_created }}
        uses: docker/setup-buildx-action@v2
        
      - name: Build and push container
        if: ${{ steps.release.outputs.release_created }}
        run: |
          # Extract the ansible-core version (without the build suffix)
          ANSIBLE_VERSION=$(echo $VERSION | sed -E 's/^(.*)-[0-9]+$/\1/')
          
          # Build the container with the ansible version
          make build ANSIBLE_VERSION=$ANSIBLE_VERSION
          
          # Tag with the full version including build number
          docker tag containerized-ansible:$ANSIBLE_VERSION containerized-ansible:$VERSION
          
          # Push the container if needed
          # docker push containerized-ansible:$VERSION